<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Space Crew ğŸš€</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#0a0a1a;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      min-height:100vh; font-family:'Courier New',monospace; overflow:hidden; color:white;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       START SCREEN
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #start-screen {
      position:fixed; inset:0; z-index:200;
      background:radial-gradient(ellipse at 40% 40%, #0d1b3e 0%, #050510 80%);
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0;
    }
    #start-screen.hidden { display:none; }

    .start-stars { position:absolute; inset:0; overflow:hidden; pointer-events:none; }

    #start-title {
      font-size:3rem; letter-spacing:10px; color:#a0c4ff;
      text-shadow:0 0 30px #4488ff, 0 0 60px #4488ff44;
      text-transform:uppercase; margin-bottom:6px;
      animation:title-glow 3s ease-in-out infinite;
    }
    @keyframes title-glow { 0%,100%{text-shadow:0 0 30px #4488ff,0 0 60px #4488ff44;} 50%{text-shadow:0 0 50px #89cff0,0 0 100px #89cff066;} }

    #start-subtitle { font-size:0.7rem; letter-spacing:4px; color:#446; text-transform:uppercase; margin-bottom:40px; }

    .rules-box {
      background:rgba(10,20,50,0.8); border:1px solid #1a3060; border-radius:14px;
      padding:24px 32px; max-width:540px; margin-bottom:32px;
    }
    .rules-box h2 { font-size:0.65rem; letter-spacing:4px; color:#4488ff; text-transform:uppercase; margin-bottom:16px; text-align:center; }
    .rule { display:flex; align-items:flex-start; gap:12px; margin-bottom:12px; font-size:0.6rem; color:#668; letter-spacing:1px; line-height:1.6; }
    .rule-icon { font-size:1.1rem; flex-shrink:0; width:24px; text-align:center; }
    .rule b { color:#a0c4ff; }

    .controls-row { display:flex; gap:20px; margin-bottom:28px; }
    .key-hint { display:flex; align-items:center; gap:8px; font-size:0.55rem; color:#446; letter-spacing:2px; text-transform:uppercase; }
    .key { background:#111a33; border:1px solid #334; border-radius:4px; padding:3px 8px; font-size:0.6rem; color:#89cff0; font-family:'Courier New',monospace; }

    #start-btn {
      background:transparent; border:2px solid #89cff0; color:#89cff0;
      font-family:'Courier New',monospace; font-size:0.75rem; letter-spacing:4px;
      padding:10px 36px; border-radius:8px; cursor:pointer; text-transform:uppercase;
      transition:all .2s; animation:pulse-btn 2s ease-in-out infinite;
    }
    #start-btn:hover { background:rgba(137,207,240,0.15); box-shadow:0 0 20px #89cff044; }
    @keyframes pulse-btn { 0%,100%{box-shadow:0 0 8px #89cff033;} 50%{box-shadow:0 0 20px #89cff077;} }

    .diff-select { display:flex; gap:8px; margin-bottom:20px; }
    .start-diff-btn {
      background:transparent; border:1px solid #334; color:#556;
      font-family:'Courier New',monospace; font-size:0.6rem; letter-spacing:1px;
      padding:4px 14px; border-radius:4px; cursor:pointer; text-transform:uppercase; transition:all .15s;
    }
    .start-diff-btn:hover  { border-color:#89cff0; color:#89cff0; }
    .start-diff-btn.active { border-color:#89cff0; color:#89cff0; background:rgba(137,207,240,0.1); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GAME UI
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #game-ui { display:flex; flex-direction:column; align-items:center; gap:0; }
    #game-ui.hidden { display:none; }

    h1 { font-size:1.2rem; letter-spacing:4px; color:#a0c4ff; margin-bottom:4px; text-shadow:0 0 12px #4488ff; text-transform:uppercase; }

    #top-bar { display:flex; align-items:center; gap:14px; margin-bottom:6px; width:100%; justify-content:space-between; }
    #hint { font-size:0.58rem; color:#445; letter-spacing:1px; }
    #stopwatch { font-size:0.85rem; color:#ffd166; letter-spacing:4px; font-weight:bold; text-shadow:0 0 8px #ffd16666; min-width:80px; text-align:center; }
    #top-right { display:flex; gap:6px; align-items:center; }

    .diff-btn {
      background:transparent; border:1px solid #334; color:#778;
      font-family:'Courier New',monospace; font-size:0.58rem; letter-spacing:1px;
      padding:2px 8px; border-radius:4px; cursor:pointer; text-transform:uppercase; transition:all .15s;
    }
    .diff-btn:hover  { border-color:#89cff0; color:#89cff0; }
    .diff-btn.active { border-color:#89cff0; color:#89cff0; background:rgba(137,207,240,0.1); }

    #outer-wrap { display:flex; flex-direction:column; gap:5px; }
    #progress-wrap { display:flex; align-items:center; gap:10px; }
    #progress-label { font-size:0.56rem; color:#4466aa; letter-spacing:2px; white-space:nowrap; text-transform:uppercase; }
    #progress-track { flex:1; height:9px; background:#111a33; border-radius:5px; border:1px solid #223366; overflow:hidden; }
    #progress-fill  { height:100%; width:0%; background:linear-gradient(90deg,#4488ff,#89cff0); border-radius:5px; transition:width .4s ease; box-shadow:0 0 8px #4488ff88; }
    #progress-pct   { font-size:0.58rem; color:#89cff0; letter-spacing:1px; min-width:30px; text-align:right; }

    #game-wrap { display:flex; gap:10px; align-items:flex-start; }

    #game-container {
      position:relative; width:900px; height:510px;
      border:2px solid #223366; border-radius:16px; overflow:hidden;
      background:radial-gradient(ellipse at 30% 40%,#0d1b3e 0%,#050510 70%);
      box-shadow:0 0 40px rgba(60,100,255,.2), inset 0 0 60px rgba(0,0,0,.5);
      flex-shrink:0;
    }

    /* Danger vignette */
    #danger-vignette { position:absolute; inset:0; z-index:45; pointer-events:none; border-radius:14px; }
    #danger-vignette.level1 { box-shadow:inset 0 0 40px 10px rgba(255,30,30,0.25); }
    #danger-vignette.level2 { box-shadow:inset 0 0 70px 20px rgba(255,30,30,0.45); animation:pulse-danger 1s ease-in-out infinite; }
    #danger-vignette.level3 { box-shadow:inset 0 0 90px 30px rgba(255,30,30,0.65); animation:pulse-danger .35s ease-in-out infinite; }
    @keyframes pulse-danger { 0%,100%{opacity:1;} 50%{opacity:.35;} }

    /* Task panel */
    #task-panel {
      width:185px; background:rgba(10,15,40,0.92);
      border:1.5px solid #1a3060; border-radius:12px; padding:10px; flex-shrink:0;
    }
    #task-panel h2 { font-size:0.58rem; letter-spacing:3px; color:#4488ff; text-transform:uppercase; margin-bottom:8px; border-bottom:1px solid #1a3060; padding-bottom:5px; }
    .task-item { display:flex; align-items:flex-start; gap:5px; margin-bottom:7px; font-size:0.52rem; color:#667; letter-spacing:1px; line-height:1.4; transition:color .3s; }
    .task-item.done { color:#2a5a2a; text-decoration:line-through; }
    .task-item .tick { width:10px; height:10px; border-radius:2px; border:1px solid #334; flex-shrink:0; margin-top:1px; display:flex; align-items:center; justify-content:center; font-size:0.4rem; transition:all .3s; }
    .task-item.done .tick { background:#2a8a2a; border-color:#2a8a2a; color:white; }
    .task-room { color:#89cff0; }

    .panel-divider { margin:10px 0 8px; border-top:1px solid #1a3060; padding-top:8px; font-size:0.48rem; color:#334; letter-spacing:2px; text-transform:uppercase; margin-bottom:5px; }
    .crew-row { display:flex; align-items:center; gap:5px; font-size:0.46rem; color:#446; letter-spacing:1px; margin-bottom:4px; }
    .crew-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }

    /* Best time */
    #best-time-display { font-size:0.48rem; color:#556; letter-spacing:1px; margin-top:10px; border-top:1px solid #1a3060; padding-top:8px; }
    #best-time-display span { color:#ffd166; }

    /* Stars */
    .star { position:absolute; background:white; border-radius:50%; opacity:0; animation:twinkle var(--dur) ease-in-out infinite var(--delay); }
    @keyframes twinkle { 0%,100%{opacity:.1;transform:scale(1);} 50%{opacity:.9;transform:scale(1.3);} }

    /* Rooms */
    .room { position:absolute; border:1.5px solid #1a3060; border-radius:8px; background:rgba(20,40,90,.3); display:flex; align-items:flex-end; justify-content:center; padding-bottom:5px; font-size:0.48rem; color:#4466aa; letter-spacing:1px; text-transform:uppercase; }

    /* Task objects */
    .task-object { position:absolute; width:22px; height:22px; z-index:8; display:flex; align-items:center; justify-content:center; font-size:13px; border-radius:50%; transition:opacity .3s, transform .2s; }
    .task-object.done { opacity:0; pointer-events:none; }
    .task-object.click-type { background:rgba(255,220,80,0.15); border:1.5px solid rgba(255,220,80,0.7); animation:p-click 1.6s ease-in-out infinite; }
    @keyframes p-click { 0%,100%{box-shadow:0 0 4px 2px rgba(255,220,80,.3);} 50%{box-shadow:0 0 12px 5px rgba(255,220,80,.65);} }
    .task-object.hold-type  { background:rgba(100,200,255,0.12); border:1.5px solid rgba(100,200,255,0.7); animation:p-hold 1.6s ease-in-out infinite; }
    @keyframes p-hold { 0%,100%{box-shadow:0 0 4px 2px rgba(100,200,255,.25);} 50%{box-shadow:0 0 12px 5px rgba(100,200,255,.6);} }
    .task-object.seq-type   { background:rgba(180,100,255,0.12); border:1.5px solid rgba(180,100,255,0.7); animation:p-seq 1.6s ease-in-out infinite; }
    @keyframes p-seq { 0%,100%{box-shadow:0 0 4px 2px rgba(180,100,255,.25);} 50%{box-shadow:0 0 12px 5px rgba(180,100,255,.6);} }

    .task-prompt { position:absolute; z-index:20; font-size:0.42rem; letter-spacing:2px; color:#ffd166; background:rgba(5,5,20,0.85); border:1px solid #ffd16688; border-radius:4px; padding:2px 5px; white-space:nowrap; pointer-events:none; opacity:0; transition:opacity .2s; text-transform:uppercase; }
    .task-prompt.visible { opacity:1; }

    /* Characters */
    .character { position:absolute; width:26px; height:36px; z-index:10; }
    .character svg { width:100%; height:100%; }
    .char-label { position:absolute; font-size:0.38rem; letter-spacing:1px; text-align:center; width:40px; left:-7px; top:-11px; text-transform:uppercase; pointer-events:none; text-shadow:0 0 4px rgba(0,0,0,.9); }

    @keyframes caught-flash {
      0%,100%{ opacity:1; } 15%,45%,75%{ opacity:0; transform:scale(1.3); } 30%,60%{ opacity:1; transform:scale(0.8); }
    }
    .caught { animation:caught-flash .18s ease-in-out 5 !important; }

    /* Mini-game overlay */
    #minigame-overlay { display:none; position:absolute; inset:0; background:rgba(5,5,20,0.9); z-index:50; align-items:center; justify-content:center; flex-direction:column; gap:16px; }
    #minigame-overlay.active { display:flex; }
    #mg-title    { font-size:0.85rem; letter-spacing:3px; color:#a0c4ff; text-transform:uppercase; text-align:center; }
    #mg-subtitle { font-size:0.62rem; color:#89cff0; letter-spacing:2px; min-height:1.2em; }

    #hold-ui { display:none; flex-direction:column; align-items:center; gap:10px; }
    #hold-ui.active { display:flex; }
    #hold-hint  { font-size:0.6rem; color:#557; letter-spacing:2px; }
    #hold-track { width:280px; height:18px; background:#111a33; border-radius:9px; border:1px solid #223366; overflow:hidden; }
    #hold-fill  { height:100%; width:0%; background:linear-gradient(90deg,#0088ff,#00ccff); border-radius:9px; box-shadow:0 0 8px #0088ff88; }

    #seq-ui { display:none; flex-direction:column; align-items:center; gap:14px; }
    #seq-ui.active { display:flex; }
    #seq-hint     { font-size:0.58rem; color:#557; letter-spacing:2px; }
    #seq-progress { font-size:0.65rem; color:#c77dff; letter-spacing:2px; }
    #seq-keys     { display:flex; gap:8px; }
    .seq-key { width:42px; height:42px; border-radius:7px; border:2px solid #334; background:#111a33; display:flex; align-items:center; justify-content:center; font-size:1.1rem; color:#556; font-weight:bold; transition:all .15s; }
    .seq-key.active  { border-color:#c77dff; color:#c77dff; background:rgba(180,100,255,.18); box-shadow:0 0 12px #c77dff99; }
    .seq-key.correct { border-color:#6bff8e; color:#6bff8e; background:rgba(100,255,140,.12); }
    .seq-key.wrong   { border-color:#ff4444; color:#ff4444; background:rgba(255,60,60,.12); animation:shake .3s; }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
    #mg-cancel { font-size:0.48rem; color:#334; letter-spacing:2px; margin-top:4px; }

    /* End screens */
    #win-banner, #gameover-banner {
      display:none; position:absolute; inset:0; z-index:60;
      align-items:center; justify-content:center; flex-direction:column; gap:12px;
    }
    #win-banner { background:rgba(5,15,5,0.95); }
    #gameover-banner { background:rgba(20,0,0,0.95); }
    #win-banner.active, #gameover-banner.active { display:flex; }
    #win-banner h2 { font-size:1.7rem; letter-spacing:6px; color:#ffd166; text-shadow:0 0 24px #ffd16688; text-transform:uppercase; }
    #win-banner .win-time { font-size:1rem; color:#6bff8e; letter-spacing:4px; margin:4px 0; }
    #win-banner .best-label { font-size:0.6rem; color:#446; letter-spacing:3px; }
    #gameover-banner h2 { font-size:1.7rem; letter-spacing:6px; color:#ff4444; text-shadow:0 0 30px #ff444488; text-transform:uppercase; animation:flicker 2s ease-in-out infinite; }
    @keyframes flicker { 0%,100%{opacity:1;} 50%{opacity:.6;} }
    .reveal { font-size:0.72rem; color:#ff9999; letter-spacing:3px; margin-top:2px; }
    .reveal span { font-weight:bold; }

    .end-btn {
      margin-top:6px; padding:7px 22px; background:transparent;
      border:1px solid #89cff0; color:#89cff0; font-family:'Courier New',monospace;
      font-size:0.62rem; letter-spacing:2px; border-radius:6px; cursor:pointer; text-transform:uppercase;
      transition:background .15s;
    }
    .end-btn:hover { background:rgba(137,207,240,0.12); }

    #infobar { margin-top:5px; font-size:0.62rem; color:#4466aa; letter-spacing:2px; }
    #infobar span { color:#a0c4ff; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LEADERBOARD OVERLAY
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #leaderboard-overlay {
      position:fixed; inset:0; z-index:300;
      background:rgba(3,5,18,0.97);
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px;
    }
    #leaderboard-overlay.hidden { display:none; }
    #lb-title { font-size:1.5rem; letter-spacing:8px; color:#ffd166; text-shadow:0 0 20px #ffd16666; text-transform:uppercase; }
    #lb-tabs { display:flex; gap:8px; }
    .lb-tab {
      background:transparent; border:1px solid #334; color:#556;
      font-family:'Courier New',monospace; font-size:0.62rem; letter-spacing:2px;
      padding:5px 18px; border-radius:5px; cursor:pointer; text-transform:uppercase; transition:all .15s;
    }
    .lb-tab:hover  { border-color:#ffd166; color:#ffd166; }
    .lb-tab.active { border-color:#ffd166; color:#ffd166; background:rgba(255,209,102,0.08); }
    #lb-table-wrap {
      background:rgba(10,15,40,0.9); border:1.5px solid #1a3060; border-radius:14px;
      padding:20px 28px; min-width:420px; min-height:300px;
    }
    #lb-table-wrap table { width:100%; border-collapse:collapse; }
    #lb-table-wrap th { font-size:0.5rem; letter-spacing:3px; color:#4466aa; text-transform:uppercase; padding-bottom:10px; border-bottom:1px solid #1a3060; text-align:left; }
    #lb-table-wrap th:last-child { text-align:right; }
    #lb-table-wrap td { font-size:0.58rem; color:#668; letter-spacing:1px; padding:7px 0; border-bottom:1px solid #0d1530; vertical-align:middle; }
    #lb-table-wrap td:last-child { text-align:right; color:#ffd166; }
    #lb-table-wrap tr:last-child td { border-bottom:none; }
    .lb-rank-1 td { color:#ffd166 !important; font-size:0.65rem; }
    .lb-rank-2 td { color:#b0bec5 !important; }
    .lb-rank-3 td { color:#cd7f32 !important; }
    .lb-empty { font-size:0.58rem; color:#334; letter-spacing:2px; text-align:center; padding:50px 0; }
    .lb-new-row td { color:#6bff8e !important; animation:lb-flash .5s ease-in-out 4; }
    @keyframes lb-flash { 0%,100%{opacity:1;} 50%{opacity:0.2;} }
    .lb-btns { display:flex; gap:10px; align-items:center; }
    #lb-close-btn {
      background:transparent; border:1px solid #89cff0; color:#89cff0;
      font-family:'Courier New',monospace; font-size:0.62rem; letter-spacing:2px;
      padding:6px 20px; border-radius:6px; cursor:pointer; text-transform:uppercase; transition:all .15s;
    }
    #lb-close-btn:hover { background:rgba(137,207,240,0.12); }
    #lb-clear-btn {
      background:transparent; border:1px solid #332; color:#554;
      font-family:'Courier New',monospace; font-size:0.5rem; letter-spacing:2px;
      padding:5px 12px; border-radius:5px; cursor:pointer; text-transform:uppercase; transition:all .15s;
    }
    #lb-clear-btn:hover { border-color:#ff4444; color:#ff4444; }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     START SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="start-screen">
  <div class="start-stars" id="start-stars"></div>

  <div id="start-title">ğŸš€ Space Crew</div>
  <div id="start-subtitle">A game by us</div>

  <div class="rules-box">
    <h2>ğŸ“‹ How to Play</h2>
    <div class="rule"><div class="rule-icon">ğŸ¯</div><div>Complete <b>all 6 tasks</b> around the spaceship before time runs out!</div></div>
    <div class="rule"><div class="rule-icon">ğŸ•µï¸</div><div><b>One crew member is the imposter.</b> They look just like everyone else â€” but they'll start chasing you. Figure out who it is by watching carefully!</div></div>
    <div class="rule"><div class="rule-icon">ğŸ”§</div><div><b>Click tasks</b> â€” walk close and press <b style="color:#ffd166">E</b> to fix instantly</div></div>
    <div class="rule"><div class="rule-icon">âš•ï¸</div><div><b>Hold tasks</b> â€” press <b style="color:#ffd166">E</b> then hold <b style="color:#89cff0">SPACE</b> to fill the bar. Let go and it drains!</div></div>
    <div class="rule"><div class="rule-icon">âŒ¨ï¸</div><div><b>Typing tasks</b> â€” press <b style="color:#ffd166">E</b> then type the letters shown in order</div></div>
    <div class="rule"><div class="rule-icon">â¤ï¸</div><div>If the imposter <b>catches you</b> â€” game over! The screen will flash red when they're near...</div></div>
  </div>

  <div style="font-size:0.58rem;color:#446;letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;">Choose difficulty</div>
  <div class="diff-select">
    <button class="start-diff-btn active" data-count="4">Easy â€” 4 crew</button>
    <button class="start-diff-btn" data-count="6">Medium â€” 6 crew</button>
    <button class="start-diff-btn" data-count="8">Hard â€” 8 crew</button>
  </div>

  <button id="start-btn">â–¶ Start Game</button>
  <button id="open-lb-btn" style="margin-top:10px;background:transparent;border:none;color:#446;font-family:'Courier New',monospace;font-size:0.55rem;letter-spacing:2px;cursor:pointer;text-transform:uppercase;text-decoration:underline;">ğŸ† View Leaderboard</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GAME UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game-ui" class="hidden">
  <h1>ğŸš€ Space Crew</h1>
  <div id="top-bar">
    <div id="hint">ğŸ•¹ Arrows Â· <span style="color:#ffd166">E</span> interact Â· <span style="color:#89cff0">SPACE</span> hold Â· ESC cancel</div>
    <div id="stopwatch">0:00</div>
    <div id="top-right">
      <button class="diff-btn active" data-count="4">Easy</button>
      <button class="diff-btn" data-count="6">Medium</button>
      <button class="diff-btn" data-count="8">Hard</button>
    </div>
  </div>

  <div id="outer-wrap">
    <div id="progress-wrap">
      <div id="progress-label">Tasks</div>
      <div id="progress-track"><div id="progress-fill"></div></div>
      <div id="progress-pct">0%</div>
    </div>

    <div id="game-wrap">
      <div id="game-container">
        <div id="danger-vignette"></div>

        <div id="minigame-overlay">
          <div id="mg-title"></div>
          <div id="mg-subtitle"></div>
          <div id="hold-ui">
            <div id="hold-hint">Hold <strong style="color:#89cff0">SPACE</strong> to fix... let go and it drains!</div>
            <div id="hold-track"><div id="hold-fill"></div></div>
          </div>
          <div id="seq-ui">
            <div id="seq-hint">Type the keys in order â€” wrong key resets!</div>
            <div id="seq-keys"></div>
            <div id="seq-progress"></div>
          </div>
          <div id="mg-cancel">ESC to cancel</div>
        </div>

        <div id="win-banner">
          <h2>ğŸ‰ Crew Saved!</h2>
          <div class="win-time" id="win-time-display"></div>
          <div class="best-label" id="win-best-label"></div>
          <button class="end-btn" id="win-again">Play Again</button>
          <button class="end-btn" style="border-color:#446;color:#446;" id="win-menu">Main Menu</button>
          <button class="end-btn" style="border-color:#ffd166;color:#ffd166;" id="win-lb-btn">ğŸ† Leaderboard</button>
        </div>

        <div id="gameover-banner">
          <h2>â˜  Caught!</h2>
          <div class="reveal">The imposter was <span id="imposter-reveal">???</span></div>
          <button class="end-btn" id="retry-btn">Try Again</button>
          <button class="end-btn" style="border-color:#446;color:#446;" id="go-menu">Main Menu</button>
        </div>
      </div>

      <div id="task-panel">
        <h2>ğŸ“‹ Tasks</h2>
        <div id="task-list"></div>
        <div class="panel-divider">Crew</div>
        <div id="crew-list"></div>
        <div id="best-time-display">Best time: <span id="best-time-val">â€”</span></div>
      </div>
    </div>
  </div>

  <div id="infobar">Room: <span id="room-name">Hallway</span></div>
</div>

<!-- LEADERBOARD OVERLAY -->
<div id="leaderboard-overlay" class="hidden">
  <div id="lb-title">ğŸ† Leaderboard</div>
  <div id="lb-tabs">
    <button class="lb-tab active" data-diff="4">Easy</button>
    <button class="lb-tab" data-diff="6">Medium</button>
    <button class="lb-tab" data-diff="8">Hard</button>
  </div>
  <div id="lb-table-wrap">
    <div class="lb-empty" id="lb-empty">No times yet â€” play a game!</div>
    <table id="lb-table" style="display:none">
      <thead><tr><th>#</th><th>Name</th><th>Time</th></tr></thead>
      <tbody id="lb-tbody"></tbody>
    </table>
  </div>
  <div class="lb-btns">
    <button id="lb-close-btn">â† Back</button>
    <button id="lb-clear-btn">Clear this board</button>
  </div>
</div>

<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SOUND ENGINE (Web Audio API â€” no files needed)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;

  function getAudio() {
    if (!audioCtx) audioCtx = new AudioCtx();
    return audioCtx;
  }

  function playTone(freq, type, duration, volume=0.3, startFreq=null) {
    try {
      const ctx = getAudio();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.type = type;
      if (startFreq) { osc.frequency.setValueAtTime(startFreq, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(freq, ctx.currentTime+duration*0.8); }
      else osc.frequency.setValueAtTime(freq, ctx.currentTime);
      gain.gain.setValueAtTime(volume, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+duration);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime+duration);
    } catch(e) {}
  }

  function soundTaskComplete() {
    // Happy ascending chime
    playTone(440, 'sine', 0.12, 0.25);
    setTimeout(()=>playTone(550, 'sine', 0.12, 0.25), 80);
    setTimeout(()=>playTone(660, 'sine', 0.18, 0.25), 160);
    setTimeout(()=>playTone(880, 'sine', 0.25, 0.25), 240);
  }

  function soundWin() {
    // Fanfare
    const notes = [523,659,784,1047,1319];
    notes.forEach((f,i) => setTimeout(()=>playTone(f,'sine',0.3,0.3), i*100));
    setTimeout(()=>{ playTone(1047,'sine',0.5,0.35); playTone(1319,'sine',0.5,0.25); }, 550);
  }

  function soundCaught() {
    // Scary descending buzz
    playTone(150, 'sawtooth', 0.6, 0.5, 600);
    setTimeout(()=>playTone(80, 'sawtooth', 0.8, 0.5, 300), 200);
    setTimeout(()=>playTone(50, 'square', 1.0, 0.5), 500);
  }

  // Danger heartbeat â€” called from game loop based on distance
  let lastDangerLevel = 0;
  let dangerBeepTimer = 0;
  function soundDangerTick(level) {
    // level 1,2,3 â€” rate increases
    if (level === 0) { dangerBeepTimer=0; return; }
    dangerBeepTimer--;
    if (dangerBeepTimer <= 0) {
      const interval = level===3 ? 18 : level===2 ? 40 : 75; // frames between beeps
      dangerBeepTimer = interval;
      const freq = level===3 ? 880 : level===2 ? 660 : 440;
      playTone(freq, 'sine', 0.06, 0.12);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CONSTANTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const GAME_W=900, GAME_H=510;
  const CHAR_W=26, CHAR_H=36;
  const PLAYER_SPEED=3;
  const IMP_WANDER=0.8, IMP_CHASE=2.2;
  const CHASE_DIST=160, CAUGHT_DIST=22, INTERACT_DIST=52;
  const DANGER_1=220, DANGER_2=130, DANGER_3=70;

  const CREW_COLORS=['#89cff0','#ff6b6b','#6bff8e','#ffd166','#c77dff','#ff9f1c','#f72585','#4cc9f0'];
  const CREW_NAMES =['You','Rex','Zara','Bolt','Nova','Finn','Lyra','Orb'];

  const ROOMS=[
    {name:'Cockpit',    x:20,  y:20,  w:220,h:130},
    {name:'Medbay',     x:340, y:20,  w:220,h:140},
    {name:'Reactor',    x:660, y:20,  w:220,h:150},
    {name:'Engine Room',x:20,  y:325, w:240,h:175},
    {name:'Cafeteria',  x:330, y:330, w:240,h:170},
    {name:'Storage',    x:640, y:330, w:240,h:170},
  ];
  const SPAWN_POS=[
    {x:430,y:220},{x:75,y:52},{x:395,y:52},{x:710,y:52},
    {x:55,y:365},{x:385,y:375},{x:690,y:375},{x:210,y:195},
  ];
  const TASK_DEFS=[
    {room:'Cockpit',    label:'Fix the nav panel',   type:'click',icon:'ğŸ”§',ox:120,oy:58},
    {room:'Medbay',     label:'Hold the scanner',    type:'hold', icon:'âš•ï¸', ox:110,oy:65},
    {room:'Reactor',    label:'Enter launch code',   type:'seq',  icon:'âŒ¨ï¸', ox:112,oy:68},
    {room:'Engine Room',label:'Click the fuel valve',type:'click',icon:'âš™ï¸', ox:118,oy:78},
    {room:'Cafeteria',  label:'Hold the coffee brew',type:'hold', icon:'â˜•', ox:120,oy:74},
    {room:'Storage',    label:'Type door code',      type:'seq',  icon:'ğŸ”‘', ox:120,oy:78},
  ];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let tasks=[], activeTask=null, holdProgress=0, holdHeld=false;
  let seqIndex=0, seqKeys=[];
  let playerEl=null, playerX=SPAWN_POS[0].x, playerY=SPAWN_POS[0].y, facingLeft=false;
  let gameBlocked=false, gameover=false;
  const keysDown={};
  let crewCount=4, imposterIdx=-1, crewEls=[], crewPos=[], crewDir=[], crewWander=[];
  let bestTime=null;

  // Stopwatch
  let swRunning=false, swStart=0, swElapsed=0;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  DOM
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const gc=document.getElementById('game-container');
  const progressFill=document.getElementById('progress-fill');
  const progressPct=document.getElementById('progress-pct');
  const taskListEl=document.getElementById('task-list');
  const crewListEl=document.getElementById('crew-list');
  const roomNameEl=document.getElementById('room-name');
  const overlay=document.getElementById('minigame-overlay');
  const mgTitle=document.getElementById('mg-title');
  const mgSubtitle=document.getElementById('mg-subtitle');
  const holdUI=document.getElementById('hold-ui');
  const holdFillEl=document.getElementById('hold-fill');
  const seqUI=document.getElementById('seq-ui');
  const seqKeysEl=document.getElementById('seq-keys');
  const seqProgressEl=document.getElementById('seq-progress');
  const winBanner=document.getElementById('win-banner');
  const gameoverBanner=document.getElementById('gameover-banner');
  const dangerVignette=document.getElementById('danger-vignette');
  const stopwatchEl=document.getElementById('stopwatch');
  const bestTimeVal=document.getElementById('best-time-val');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  START SCREEN STARS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const ss=document.getElementById('start-stars');
  for(let i=0;i<120;i++){
    const s=document.createElement('div'); s.className='star';
    const sz=Math.random()*2.5+0.5;
    s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${(Math.random()*3+1.5).toFixed(1)}s;--delay:-${(Math.random()*4).toFixed(1)}s;`;
    ss.appendChild(s);
  }

  // Start screen difficulty
  let startDiffCount=4;
  document.querySelectorAll('.start-diff-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.start-diff-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      startDiffCount=parseInt(btn.dataset.count);
      // sync game diff buttons
      document.querySelectorAll('.diff-btn').forEach(b=>b.classList.toggle('active', parseInt(b.dataset.count)===startDiffCount));
    });
  });

  document.getElementById('start-btn').addEventListener('click',()=>{
    getAudio(); // unlock audio on first user gesture
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-ui').classList.remove('hidden');
    startNewGame(startDiffCount);
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  STOPWATCH
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function swStart_() { swStart=performance.now()-swElapsed; swRunning=true; }
  function swStop()   { swElapsed=performance.now()-swStart; swRunning=false; }
  function swReset()  { swElapsed=0; swRunning=false; stopwatchEl.textContent='0:00'; }
  function swTick()   {
    if(!swRunning) return;
    swElapsed=performance.now()-swStart;
    const total=Math.floor(swElapsed/1000);
    const m=Math.floor(total/60), s=total%60;
    stopwatchEl.textContent=`${m}:${s.toString().padStart(2,'0')}`;
  }
  function swGetSeconds() { return Math.floor(swElapsed/1000); }
  function swFormat(sec)  { const m=Math.floor(sec/60),s=sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  STARFIELD (game)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function buildStarfield() {
    gc.querySelectorAll('.star').forEach(e=>e.remove());
    for(let i=0;i<130;i++){
      const s=document.createElement('div'); s.className='star';
      const sz=Math.random()*2.5+0.5;
      s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${(Math.random()*3+1.5).toFixed(1)}s;--delay:-${(Math.random()*4).toFixed(1)}s;`;
      gc.appendChild(s);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ROOMS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function buildRooms() {
    gc.querySelectorAll('.room').forEach(e=>e.remove());
    ROOMS.forEach(r=>{
      const div=document.createElement('div'); div.className='room';
      div.style.cssText=`left:${r.x}px;top:${r.y}px;width:${r.w}px;height:${r.h}px;`;
      div.textContent=r.name; gc.appendChild(div);
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CHARACTER SVG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function makeCharSVG(color){
    return `<svg viewBox="0 0 60 80" xmlns="http://www.w3.org/2000/svg">
      <circle cx="30" cy="13" r="11" fill="${color}" stroke="rgba(0,0,0,.35)" stroke-width="2"/>
      <line x1="24" y1="10" x2="27" y2="12" stroke="rgba(0,0,0,.45)" stroke-width="1.8" stroke-linecap="round"/>
      <circle cx="27" cy="13" r="1.5" fill="rgba(0,0,0,.5)"/>
      <circle cx="34" cy="13" r="1.5" fill="rgba(0,0,0,.5)"/>
      <path d="M26 17 Q30 20 34 17" stroke="rgba(0,0,0,.45)" stroke-width="1.5" fill="none" stroke-linecap="round"/>
      <line x1="30" y1="24" x2="30" y2="30" stroke="${color}" stroke-width="3" stroke-linecap="round"/>
      <line x1="30" y1="30" x2="30" y2="52" stroke="${color}" stroke-width="3" stroke-linecap="round"/>
      <line x1="30" y1="35" x2="14" y2="22" stroke="${color}" stroke-width="3" stroke-linecap="round"/>
      <circle cx="14" cy="22" r="2.5" fill="${color}" stroke="rgba(0,0,0,.3)" stroke-width="1"/>
      <line x1="16" y1="20" x2="4" y2="5" stroke="#ddeeff" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="11" y1="13" x2="18" y2="10" stroke="${color}" stroke-width="2" stroke-linecap="round"/>
      <line x1="30" y1="35" x2="47" y2="42" stroke="${color}" stroke-width="3" stroke-linecap="round"/>
      <circle cx="47" cy="42" r="2.5" fill="${color}" stroke="rgba(0,0,0,.3)" stroke-width="1"/>
      <line x1="30" y1="52" x2="18" y2="68" stroke="${color}" stroke-width="3" stroke-linecap="round"/>
      <line x1="18" y1="68" x2="10" y2="72" stroke="${color}" stroke-width="3" stroke-linecap="round"/>
      <line x1="30" y1="52" x2="40" y2="68" stroke="${color}" stroke-width="3" stroke-linecap="round"/>
      <line x1="40" y1="68" x2="48" y2="72" stroke="${color}" stroke-width="3" stroke-linecap="round"/>
    </svg>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CREW
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function buildCrew(count){
    gc.querySelectorAll('.character').forEach(e=>e.remove());
    crewEls=[]; crewPos=[]; crewDir=[]; crewWander=[]; playerEl=null; crewCount=count;
    imposterIdx=Math.floor(Math.random()*(count-1))+1;
    crewListEl.innerHTML='';

    for(let i=0;i<count;i++){
      const color=CREW_COLORS[i];
      const el=document.createElement('div'); el.className='character';
      el.innerHTML=makeCharSVG(color);
      el.querySelector('svg').style.filter=`drop-shadow(0 0 4px ${color})`;
      const lbl=document.createElement('div'); lbl.className='char-label'; lbl.style.color=color; lbl.textContent=CREW_NAMES[i];
      el.appendChild(lbl);
      const sp=SPAWN_POS[i] || {x: 100 + (i*60), y: 200};
      el.style.left=(i===0?playerX:sp.x)+'px'; el.style.top=(i===0?playerY:sp.y)+'px';
      gc.appendChild(el); crewEls.push(el);

      if(i===0){ playerEl=el; }
      else {
        crewPos.push({x:sp.x,y:sp.y});
        const a=Math.random()*Math.PI*2;
        crewDir.push({vx:Math.cos(a),vy:Math.sin(a)});
        crewWander.push(Math.floor(Math.random()*120)+60);
      }

      // Panel crew list
      const row=document.createElement('div'); row.className='crew-row';
      const dot=document.createElement('div'); dot.className='crew-dot'; dot.style.background=color;
      row.appendChild(dot);
      row.appendChild(document.createTextNode(i===0?CREW_NAMES[i]+' (you)':CREW_NAMES[i]));
      crewListEl.appendChild(row);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  TASKS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function buildTasks(){
    gc.querySelectorAll('.task-object,.task-prompt').forEach(e=>e.remove());
    tasks=[]; taskListEl.innerHTML='';
    TASK_DEFS.forEach(def=>{
      const room=ROOMS.find(r=>r.name===def.room); if(!room) return;
      const ax=room.x+def.ox, ay=room.y+def.oy;
      const obj=document.createElement('div'); obj.className=`task-object ${def.type}-type`; obj.textContent=def.icon;
      obj.style.left=(ax-11)+'px'; obj.style.top=(ay-11)+'px'; gc.appendChild(obj);
      const prompt=document.createElement('div'); prompt.className='task-prompt'; prompt.textContent='Press E';
      prompt.style.left=(ax-14)+'px'; prompt.style.top=(ay-26)+'px'; gc.appendChild(prompt);
      const item=document.createElement('div'); item.className='task-item';
      const tl=def.type==='click'?'ğŸ”§':def.type==='hold'?'âš•ï¸':'âŒ¨ï¸';
      item.innerHTML=`<div class="tick"></div><div>${tl} <span class="task-room">${def.room}:</span><br>${def.label}</div>`;
      taskListEl.appendChild(item);
      tasks.push({def,obj,prompt,listItem:item,done:false,ax,ay});
    });
    updateProgress();
  }

  function updateProgress(){
    const done=tasks.filter(t=>t.done).length, total=tasks.length;
    const pct=total?Math.round((done/total)*100):0;
    progressFill.style.width=pct+'%'; progressPct.textContent=pct+'%';
    if(done===total&&total>0) showWin();
  }

  function completeTask(task){
    if(!task||task.done) return;
    task.done=true; task.obj.classList.add('done'); task.prompt.classList.remove('visible');
    task.listItem.classList.add('done'); task.listItem.querySelector('.tick').textContent='âœ“';
    soundTaskComplete();
    closeOverlay(); updateProgress();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  IMPOSTER AI
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function updateImposter(){
    if(gameover || crewPos.length === 0 || imposterIdx < 1) return;
    const npcI=imposterIdx-1, pos=crewPos[npcI], el=crewEls[imposterIdx];
    const px=playerX+CHAR_W/2, py=playerY+CHAR_H/2;
    const ix=pos.x+CHAR_W/2, iy=pos.y+CHAR_H/2;
    const dist=Math.hypot(px-ix,py-iy);

    // Danger level
    let level=0;
    if(dist<DANGER_3) level=3;
    else if(dist<DANGER_2) level=2;
    else if(dist<DANGER_1) level=1;
    dangerVignette.className=level>0?`level${level}`:'';
    soundDangerTick(level);

    if(dist<CAUGHT_DIST){ triggerCaught(); return; }

    let speed,dx,dy;
    if(dist<CHASE_DIST){
      speed=IMP_CHASE; dx=px-ix; dy=py-iy;
      const len=Math.hypot(dx,dy)||1; dx/=len; dy/=len;
    } else {
      speed=IMP_WANDER;
      crewWander[npcI]--;
      if(crewWander[npcI]<=0){
        const a=Math.random()*Math.PI*2;
        crewDir[npcI]={vx:Math.cos(a),vy:Math.sin(a)};
        crewWander[npcI]=Math.floor(Math.random()*180)+60;
      }
      dx=crewDir[npcI].vx; dy=crewDir[npcI].vy;
    }
    pos.x=Math.max(0,Math.min(GAME_W-CHAR_W,pos.x+dx*speed));
    pos.y=Math.max(0,Math.min(GAME_H-CHAR_H,pos.y+dy*speed));
    el.style.left=pos.x+'px'; el.style.top=pos.y+'px';
    el.style.transform=dx<0?'scaleX(-1)':'scaleX(1)';
  }

  function updateNPCs(){
    if(gameover || crewPos.length === 0) return;
    crewPos.forEach((pos,npcI)=>{
      if(npcI===imposterIdx-1) return;
      crewWander[npcI]--;
      if(crewWander[npcI]<=0){
        const a=Math.random()*Math.PI*2;
        crewDir[npcI]={vx:Math.cos(a),vy:Math.sin(a)};
        crewWander[npcI]=Math.floor(Math.random()*200)+80;
      }
      pos.x=Math.max(0,Math.min(GAME_W-CHAR_W,pos.x+crewDir[npcI].vx*IMP_WANDER));
      pos.y=Math.max(0,Math.min(GAME_H-CHAR_H,pos.y+crewDir[npcI].vy*IMP_WANDER));
      const el=crewEls[npcI+1];
      el.style.left=pos.x+'px'; el.style.top=pos.y+'px';
      el.style.transform=crewDir[npcI].vx<0?'scaleX(-1)':'scaleX(1)';
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CAUGHT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function triggerCaught(){
    if(gameover) return;
    gameover=true; gameBlocked=true; swStop(); closeOverlay();
    soundCaught();
    playerEl.classList.add('caught');
    setTimeout(()=>{
      gameoverBanner.classList.add('active');
      const reveal=document.getElementById('imposter-reveal');
      reveal.textContent=CREW_NAMES[imposterIdx];
      reveal.style.color=CREW_COLORS[imposterIdx];
    },900);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  PROMPTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function updatePrompts(){
    const px=playerX+CHAR_W/2, py=playerY+CHAR_H/2;
    tasks.forEach(t=>{ if(t.done) return; t.prompt.classList.toggle('visible',Math.hypot(px-t.ax,py-t.ay)<=INTERACT_DIST); });
  }

  function getNearbyTask(){
    const px=playerX+CHAR_W/2, py=playerY+CHAR_H/2;
    return tasks.find(t=>!t.done&&Math.hypot(px-t.ax,py-t.ay)<=INTERACT_DIST)||null;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  MINI-GAME
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function openTask(task){
    activeTask=task; gameBlocked=true;
    overlay.classList.add('active');
    holdUI.classList.remove('active'); seqUI.classList.remove('active'); mgSubtitle.textContent='';

    if(task.def.type==='click'){
      mgTitle.textContent=task.def.icon+' '+task.def.label;
      mgSubtitle.textContent='âœ… Done â€” nice work!';
      setTimeout(()=>completeTask(task),700);
    } else if(task.def.type==='hold'){
      mgTitle.textContent=task.def.icon+' '+task.def.label;
      holdProgress=0; holdFillEl.style.width='0%'; holdUI.classList.add('active');
    } else if(task.def.type==='seq'){
      mgTitle.textContent=task.def.icon+' '+task.def.label;
      seqIndex=0;
      const L='ASDFGHJKL';
      seqKeys=Array.from({length:5},()=>L[Math.floor(Math.random()*L.length)]);
      renderSeqKeys(); seqProgressEl.textContent=`0 / ${seqKeys.length}`; seqUI.classList.add('active');
    }
  }

  function closeOverlay(){
    overlay.classList.remove('active'); holdUI.classList.remove('active'); seqUI.classList.remove('active');
    activeTask=null; gameBlocked=gameover; holdProgress=0; holdHeld=false;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SEQUENCE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderSeqKeys(){
    seqKeysEl.innerHTML='';
    seqKeys.forEach((k,i)=>{ const d=document.createElement('div'); d.className='seq-key'+(i<seqIndex?' correct':i===seqIndex?' active':''); d.textContent=k; seqKeysEl.appendChild(d); });
  }

  function handleSeqKey(key){
    if(seqIndex>=seqKeys.length) return;
    const expected=seqKeys[seqIndex];
    const divs=seqKeysEl.querySelectorAll('.seq-key');
    if(key===expected){
      divs[seqIndex].className='seq-key correct'; seqIndex++;
      seqProgressEl.textContent=`${seqIndex} / ${seqKeys.length}`;
      if(seqIndex<seqKeys.length) divs[seqIndex].classList.add('active');
      else { seqProgressEl.textContent='âœ… Sequence complete!'; const t=activeTask; setTimeout(()=>completeTask(t),500); }
    } else {
      divs[seqIndex].classList.add('wrong');
      setTimeout(()=>{ seqIndex=0; seqProgressEl.textContent=`0 / ${seqKeys.length}`; renderSeqKeys(); },500);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  WIN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function showWin(){
    swStop(); soundWin();
    const secs=swGetSeconds();
    const isNew=bestTime===null||secs<bestTime;
    if(isNew) { bestTime=secs; bestTimeVal.textContent=swFormat(secs); }
    document.getElementById('win-time-display').textContent=`â± ${swFormat(secs)}`;
    // Save to leaderboard and get position
    const entries = lbAddScore(crewCount, secs);
    const pos = entries.findIndex(e => e.time === secs);
    const posStr = pos === 0 ? 'ğŸ¥‡ New Best Time!' : pos === 1 ? 'ğŸ¥ˆ 2nd Best!' : pos === 2 ? 'ğŸ¥‰ 3rd Best!' : pos < 10 ? `#${pos+1} on the board!` : 'Completed!';
    document.getElementById('win-best-label').textContent = posStr;
    winBanner.classList.add('active'); gameBlocked=true; gameover=true; dangerVignette.className='';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  RESET / NEW GAME
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function startNewGame(count){
    gameover=false; gameBlocked=false;
    playerX=SPAWN_POS[0].x; playerY=SPAWN_POS[0].y; facingLeft=false;
    dangerVignette.className=''; dangerBeepTimer=0;
    winBanner.classList.remove('active'); gameoverBanner.classList.remove('active');
    if(playerEl) playerEl.classList.remove('caught');
    swReset(); swStart_();
    buildCrew(count); buildTasks();
  }

  document.getElementById('win-again').addEventListener('click',()=>startNewGame(crewCount));
  document.getElementById('retry-btn').addEventListener('click',()=>startNewGame(crewCount));
  document.getElementById('win-menu').addEventListener('click',()=>{
    winBanner.classList.remove('active');
    document.getElementById('game-ui').classList.add('hidden');
    document.getElementById('start-screen').classList.remove('hidden');
    swStop(); gameover=true;
  });
  document.getElementById('go-menu').addEventListener('click',()=>{
    gameoverBanner.classList.remove('active');
    document.getElementById('game-ui').classList.add('hidden');
    document.getElementById('start-screen').classList.remove('hidden');
    swStop(); gameover=true;
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  INPUT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  document.addEventListener('keydown',e=>{
    const k=e.key;
    if(k==='Escape'){ if(gameBlocked&&!gameover) closeOverlay(); return; }
    if(k===' '){ holdHeld=true; e.preventDefault(); }
    if(gameBlocked){ if(activeTask&&activeTask.def.type==='seq'&&k.length===1) handleSeqKey(k.toUpperCase()); return; }
    keysDown[k]=true;
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(k)) e.preventDefault();
    if(k==='e'||k==='E'){ const t=getNearbyTask(); if(t) openTask(t); }
  });
  document.addEventListener('keyup',e=>{ keysDown[e.key]=false; if(e.key===' ') holdHeld=false; });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  IN-GAME DIFFICULTY BUTTONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  document.querySelectorAll('.diff-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      startNewGame(parseInt(btn.dataset.count));
    });
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  HELPERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function getRoomName(px,py){ for(const r of ROOMS) if(px>=r.x&&px<=r.x+r.w&&py>=r.y&&py<=r.y+r.h) return r.name; return 'Hallway'; }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  GAME LOOP
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function gameLoop(){
    swTick();

    if(!gameBlocked&&!gameover){
      let moved=false;
      if(keysDown['ArrowLeft'] ||keysDown['a']){playerX-=PLAYER_SPEED;facingLeft=true; moved=true;}
      if(keysDown['ArrowRight']||keysDown['d']){playerX+=PLAYER_SPEED;facingLeft=false;moved=true;}
      if(keysDown['ArrowUp']   ||keysDown['w']){playerY-=PLAYER_SPEED;moved=true;}
      if(keysDown['ArrowDown'] ||keysDown['s']){playerY+=PLAYER_SPEED;moved=true;}
      playerX=Math.max(0,Math.min(GAME_W-CHAR_W,playerX));
      playerY=Math.max(0,Math.min(GAME_H-CHAR_H,playerY));
      if(playerEl){ playerEl.style.left=playerX+'px'; playerEl.style.top=playerY+'px'; playerEl.style.transform=facingLeft?'scaleX(-1)':'scaleX(1)'; }
      if(moved) roomNameEl.textContent=getRoomName(playerX+CHAR_W/2,playerY+CHAR_H/2);
      updatePrompts();
    }

    if(activeTask&&activeTask.def.type==='hold'){
      holdProgress=holdHeld?Math.min(100,holdProgress+1.1):Math.max(0,holdProgress-0.6);
      holdFillEl.style.width=holdProgress+'%';
      if(holdProgress>=100){ const t=activeTask; completeTask(t); }
    }

    if(!gameover && crewEls.length > 0 && !activeTask){ updateNPCs(); updateImposter(); }

    requestAnimationFrame(gameLoop);
  }


  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  LEADERBOARD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const DIFF_LABELS = {4:'Easy', 6:'Medium', 8:'Hard'};
  const MEDALS = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  let lbActiveDiff = 4;
  let lbNewEntryIndex = -1; // which row to highlight as new

  function lbKey(diff) { return `spacecrew_lb_${diff}`; }

  function lbLoad(diff) {
    try { return JSON.parse(localStorage.getItem(lbKey(diff))) || []; }
    catch(e) { return []; }
  }

  function lbSave(diff, entries) {
    try { localStorage.setItem(lbKey(diff), JSON.stringify(entries)); } catch(e) {}
  }

  function lbAddScore(diff, secs) {
    const entries = lbLoad(diff);
    entries.push({ time: secs, date: new Date().toLocaleDateString() });
    entries.sort((a,b) => a.time - b.time);
    const trimmed = entries.slice(0, 10);
    lbSave(diff, trimmed);
    // Find position of new score
    lbNewEntryIndex = trimmed.findIndex(e => e.time === secs && e.date === new Date().toLocaleDateString());
    return trimmed;
  }

  function lbRender(diff, highlightIdx) {
    const entries = lbLoad(diff);
    const empty = document.getElementById('lb-empty');
    const table = document.getElementById('lb-table');
    const tbody = document.getElementById('lb-tbody');

    if (entries.length === 0) {
      empty.style.display = 'block';
      table.style.display = 'none';
      return;
    }
    empty.style.display = 'none';
    table.style.display = 'table';
    tbody.innerHTML = '';

    entries.forEach((e, i) => {
      const tr = document.createElement('tr');
      if (i < 3) tr.className = `lb-rank-${i+1}`;
      if (highlightIdx === i) tr.classList.add('lb-new-row');
      const medal = i < 3 ? `<span class="lb-medal">${MEDALS[i]}</span>` : '';
      tr.innerHTML = `<td>${medal}${i+1}</td><td>Crew â€” ${DIFF_LABELS[diff]}</td><td>${swFormat(e.time)}</td>`;
      tbody.appendChild(tr);
    });
  }

  function openLeaderboard(diff, highlightIdx=-1) {
    lbActiveDiff = diff || lbActiveDiff;
    lbNewEntryIndex = highlightIdx;
    document.querySelectorAll('.lb-tab').forEach(t => t.classList.toggle('active', parseInt(t.dataset.diff)===lbActiveDiff));
    lbRender(lbActiveDiff, highlightIdx);
    document.getElementById('leaderboard-overlay').classList.remove('hidden');
  }

  function closeLeaderboard() {
    document.getElementById('leaderboard-overlay').classList.add('hidden');
    lbNewEntryIndex = -1;
  }

  // Tab switching
  document.querySelectorAll('.lb-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      lbActiveDiff = parseInt(tab.dataset.diff);
      openLeaderboard(lbActiveDiff, -1);
    });
  });

  document.getElementById('lb-close-btn').addEventListener('click', closeLeaderboard);
  document.getElementById('open-lb-btn').addEventListener('click', () => openLeaderboard(startDiffCount));
  document.getElementById('win-lb-btn').addEventListener('click', () => openLeaderboard(crewCount, lbNewEntryIndex));

  document.getElementById('lb-clear-btn').addEventListener('click', () => {
    if (confirm(`Clear all scores for ${DIFF_LABELS[lbActiveDiff]}?`)) {
      lbSave(lbActiveDiff, []);
      lbRender(lbActiveDiff, -1);
    }
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  INIT â€” build everything but don't start til start btn
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  buildStarfield(); buildRooms();
  gameLoop(); // loop runs always; game logic waits for startNewGame()
</script>

</body>
</html>
